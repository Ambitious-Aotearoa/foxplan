{% extends "_boilerplate/_layouts/layout-base.twig" %}

{% set navigationTheme = {
    backgroundColor: 'bg-foxplan-neutral-beige',
    textColor: 'text-foxplan-charcoal-brown',
    actionBgColor: 'bg-foxplan-charcoal-brown'
} %}

{% block blockAppBody %}

    {# calculator section #}
    {# Ensure the folder is named 'calculator' (singular) and the file is 'savings-calculator.twig' #}
    {{ include('_sections/calculator/savings-calculator.twig', ignore_missing = false) }}



    {# projections section #}
    {# 1. Configuration #}
    {% set props = {
        chartTitle: 'Projections',
        backgroundColor: 'bg-foxplan-neutral-beige',
        textColor: 'text-foxplan-charcoal-brown',
        investmentColor: 'bg-foxplan-charcoal-brown',
        earningsColor: 'bg-foxplan-yellow'
    } %}

    <section id="projections-section"
             class="{{ props.backgroundColor }} w-full py-24 px-[20px] font-aktiv overflow-hidden"
             x-data="{
            showForm: false,

            calculateFV(years) {
                const p = parseFloat($store.calculator.initial) || 0;
                const pmt = parseFloat($store.calculator.monthly) || 0;
                const r_annual = $store.calculator.rate;
                const r_period = r_annual / $store.calculator.periodsPerYear;
                const n_periods = years * $store.calculator.periodsPerYear;
                if (r_period === 0) return p + (pmt * n_periods);
                return p * Math.pow((1 + r_annual), years) + pmt * ((Math.pow((1 + r_period), n_periods) - 1) / r_period);
            },

            get chartData() {
                let data = [];
                const n_years = parseFloat($store.calculator.years) || 0;
                const currentYear = new Date().getFullYear();
                const steps = 10;
                const interval = Math.max(1, Math.floor(n_years / steps));

                for (let i = 0; i <= n_years; i += interval) {
                    const currentTotal = this.calculateFV(i);
                    const currentInvested = (parseFloat($store.calculator.initial) || 0) +
                                            ((parseFloat($store.calculator.monthly) || 0) * $store.calculator.periodsPerYear * i);
                    data.push({
                        labelAge: (parseInt($store.calculator.age) || 0) + i,
                        invested: currentInvested,
                        earnings: Math.max(0, currentTotal - currentInvested),
                        total: currentTotal
                    });
                }
                return data;
            },

            get maxChartValue() {
                const lastBar = this.chartData[this.chartData.length - 1];
                return lastBar ? lastBar.total * 1.3 : 400000;
            }
         }">

        {# Include the Modal Form #}
        {% include '_components/form/form.twig' %}

        <div class="w-full relative">
            {# Header Section #}
            <div class="flex flex-col md:flex-row justify-between items-end mb-16 border-b border-black/5 pb-8">
                <h1 class="font-serif text-6xl md:text-8xl {{ props.textColor }} tracking-tight leading-none">
                    {{ props.chartTitle }}
                </h1>
                <div class="flex gap-8 mt-6 md:mt-0">
                    <div class="flex items-center gap-3">
                        <div class="w-4 h-4 {{ props.earningsColor }}"></div>
                        <span class="text-[10px] font-bold uppercase tracking-[0.2em] opacity-60">Portfolio Earnings</span>
                    </div>
                    <div class="flex items-center gap-3">
                        <div class="w-4 h-4 {{ props.investmentColor }}"></div>
                        <span class="text-[10px] font-bold uppercase tracking-[0.2em] opacity-60">Portfolio Investment</span>
                    </div>
                </div>
            </div>

            {# Chart Body - CLEAN: NO TOOLTIPS #}
            <div class="relative h-[550px] w-full mt-10">
                {# Y-Axis #}
                <div class="absolute left-0 h-full flex flex-col justify-between text-[11px] font-bold uppercase tracking-wider opacity-30 pr-10 text-right w-24 pointer-events-none z-0">
                    <span x-text="'$' + Math.round(maxChartValue).toLocaleString()"></span>
                    <span x-text="'$' + Math.round(maxChartValue * 0.75).toLocaleString()"></span>
                    <span x-text="'$' + Math.round(maxChartValue * 0.5).toLocaleString()"></span>
                    <span x-text="'$' + Math.round(maxChartValue * 0.25).toLocaleString()"></span>
                    <span>$0</span>
                </div>

                <div class="flex h-full w-full border-b border-black/10 pl-24 items-end relative">
                    <template x-for="(item, index) in chartData" :key="index">
                        <div class="relative flex-1 h-full flex flex-col items-center justify-end">

                            {# Grid Line #}
                            <div class="absolute inset-0 flex justify-center pointer-events-none">
                                <div class="w-[1px] h-full bg-black/[0.05]"></div>
                            </div>

                            {# The Bars - Purely visual, no mouse events #}
                            <div class="z-10 w-full max-w-[65px] flex flex-col-reverse mb-0">
                                <div :class="'{{ props.investmentColor }}'"
                                     :style="'height: ' + (item.invested / maxChartValue * 550) + 'px'"
                                     class="transition-all duration-700 ease-out"></div>

                                <div :class="'{{ props.earningsColor }}'"
                                     :style="'height: ' + (item.earnings / maxChartValue * 550) + 'px'"
                                     class="transition-all duration-700 delay-100 ease-out"></div>
                            </div>

                            {# X-Axis #}
                            <div class="absolute -bottom-10 flex justify-center w-full">
                                <span class="text-[12px] font-bold opacity-40" x-text="item.labelAge"></span>
                            </div>
                        </div>
                    </template>
                </div>
            </div>

            {# Button using your Component #}
            <div class="mt-20 flex justify-center">
                {{ include('_components/ui/button/button.twig', {
                    props: {
                        text: 'I want to know more',
                        style: 'primary',
                        backgroundColor: 'bg-foxplan-charcoal-brown',
                        textColor: 'text-foxplan-neutral-beige',
                        classes: 'px-14 py-6 !w-auto',
                        attributes: {
                            '@click': 'showForm = true'
                        }
                    }
                }) }}
            </div>
        </div>
    </section>

    {#  footer #}
    {{ include('_components/footer/footer-High-fidelity.twig', {
        props: {
            backgroundColor: 'bg-foxplan-charcoal-brown',
            textColor: 'text-foxplan-yellow',
            logoColor: 'text-foxplan-yellow',
            buttonColor: 'bg-foxplan-yellow',
            buttonTextColor: 'text-foxplan-charcoal-brown',
            foxplanText: 'foxplan',
            borderTopColor: 'border-foxplan-yellow/20',
            borderTopWidth: 'border-t-2'
        }
    }) }}


{% endblock %}