{% extends "_boilerplate/_layouts/layout-base.twig" %}

{% set navigationTheme = {
    backgroundColor: 'bg-foxplan-neutral-beige',
    textColor: 'text-black',
    actionBgColor: 'bg-foxplan-charcoal-brown'
} %}

{% block blockAppBody %}

    {# 1. Hero Section #}
    {% set pageHeading = (entry.title is defined and entry.title|length) ? entry.title : 'Insurance' %}
    {% set pageBody = (entry.heroBodyText is defined and entry.heroBodyText|length) ? entry.heroBodyText : 'Kiwis are a laidback bunch, but our ‘she’ll be right’ attitude also means that many of us are underinsured.' %}
    {% set pageButton = (entry.button is defined and entry.button|length) ? entry.button : 'Get in touch' %}

    {{ include('_sections/hero-sections/hero-arrow.twig', {
        props: {
            heading: pageHeading,
            bodyText: pageBody,
            buttonText: pageButton,
            imagePath: 'images/Mortgage_1.jpg',
            backgroundColor: 'bg-foxplan-neutral-beige',
            buttonUrl: '/contact',
            buttonBgColor: 'bg-foxplan-charcoal-brown',
            buttonTextColor: 'text-foxplan-white'
        }
    }) }}

    {# 2. Benefits Accordion #}
    {% set benefitsHeading = entry.paragraphHeading ?? 'Get onto the property ladder faster' %}
    {% set benefitsIntro = entry.bodyText ?? '' %}

    {% set accordionItems = [] %}
    {% if entry.accordion is defined %}
        {% for block in entry.accordion.all() %}
            {% set accordionItems = accordionItems | merge([{
                'expandableHeadingTitle': block.accordionHeading,
                'ExpandableBodyText': block.accordionBodyText
            }]) %}
        {% endfor %}
    {% endif %}

    {{ include('_sections/content-sections/benefits.twig', {
        backgroundColor: 'bg-foxplan-neutral-beige',
        textColor: 'text-foxplan-charcoal-brown',
        servicesData: {
            heading: benefitsHeading,
            intro: benefitsIntro,
            items: accordionItems
        }
    }) }}

    {# 3. Explore Services Section #}
    {% set mortgageGridItems = [] %}

    {# 1. Identify the outer block within your main Matrix field #}
    {% set exploreWrapper = (entry.infoBlock is defined)
        ? entry.infoBlock.type('exploreMortgages').one()
        : null %}

    {% if exploreWrapper %}
        {# 2. Loop through the NESTED Matrix field named 'infoBlock' #}
        {% if exploreWrapper.infoBlock is defined %}
            {# We use .all() without a .type() filter to ensure we catch the items regardless of their block type handle #}
            {% for item in exploreWrapper.infoBlock.all() %}
                {% set mortgageGridItems = mortgageGridItems | merge([{
                    'title': item.blockHeading ?? 'No Title Found',
                    'text': item.blockBodyText ?? 'No Text Found',
                    'link': item.blockLinkUrl ?? '#'
                }]) %}
            {% endfor %}
        {% endif %}
    {% endif %}

    {# 3. Call the component with the prepared data #}
    {{ include('_sections/services/our-services.twig', {
        props: {
            title: exploreWrapper.paragraphHeading2 ?? 'Explore Mortgages',
            backgroundColor: 'bg-foxplan-white',
            items: mortgageGridItems
        }
    }) }}

    {#4. Who We Work With #}
    {{ include('_sections/content-sections/who-we-work-with.twig', {
        props: {
            title: 'WHO WE WORK WITH',
            backgroundColor: 'bg-foxplan-neutral-beige',
            textColor: 'text-foxplan-charcoal-brown',
            borderColor: 'border-foxplan-charcoal-brown/20',
            logos: [
                { src: 'images/logo/AIA_Logo.svg', alt: 'AIA' },
                { src: 'images/logo/ANZ_Logo.svg', alt: 'ANZ' },
                { src: 'images/logo/BNZ_Logo.svg', alt: 'BNZ' },
                { src: 'images/logo/Kiwibank_Logo.svg', alt: 'Kiwibank' },
                { src: 'images/logo/SBS-Bank_LowQuality_Logo.svg', alt: 'SBS' },
                { src: 'images/logo/The_Co-operative_Bank_Logo.svg', alt: 'Co-op' },
                { src: 'images/logo/Westpac_logo.svg', alt: 'Westpac' },
                { src: 'images/logo/Westpac_logo.svg', alt: 'Westpac' }
            ]
        }
    }) }}

    {#5. Footer #}
    {{ include('_components/footer/footer-High-fidelity.twig', {
        props: {
            backgroundColor: 'bg-foxplan-charcoal-brown',
            textColor: 'text-foxplan-yellow',
            foxplanText: 'foxplan'
        }
    }) }}

{% endblock %}