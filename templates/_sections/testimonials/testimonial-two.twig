{# 1. Fetching the entries directly #}
{% set testimonials = craft.entries().section('testimonials').all() %}

{# 2. Merge defaults #}
{% set defaults = {
    sectionTitle: data.paragraphHeading4 ?? 'Hear what our clients are saying',
    backgroundColor: 'bg-foxplan-neutral-beige',
    textColor: 'text-foxplan-charcoal-brown',
    borderColor: 'border-foxplan-yellow',
    quoteIconColor: 'bg-foxplan-yellow',
    btnBgColor: 'bg-foxplan-charcoal-brown',
    btnTextColor: 'text-foxplan-yellow',
    arrowPath: 'images/placeholder/Arrow_1.svg'
} %}

{% set props = defaults | merge(data ?? {}) %}

{% if testimonials | length %}
    <section
            {# 20px Border on Top, Right, and Bottom. Left is open. #}
            class="relative {{ props.backgroundColor }} overflow-hidden border-t-[20px] border-r-[20px] border-b-[20px] {{ props.borderColor }}"
            x-data="{
            active: 0,
            revealed: false,
            total: {{ testimonials | length }},
            next() { this.active = (this.active + 1) % this.total },
            prev() { this.active = (this.active - 1 + this.total) % this.total },
            checkScroll() {
                if (this.revealed) return;
                let rect = this.$el.getBoundingClientRect();
                if (rect.top < window.innerHeight && rect.bottom >= 0) {
                    this.revealed = true;
                }
            }
        }"
            x-init="setTimeout(() => checkScroll(), 200)"
            @scroll.window.passive="checkScroll()"
    >
        <div class="w-full pt-24 pb-24">

            {# --- HEADER ROW --- #}
            {% if props.sectionTitle is not empty %}
                <div class="flex flex-wrap w-full items-center mb-16 md:mb-24 relative">

                    {# --- THE ARROW: Starts from edge, has padding on the right --- #}
                    <div class="hidden md:flex w-[30%] items-center justify-start pr-8 lg:pr-12">
                        <div class="w-full h-8 flex items-center">
                            <div class="transition-all duration-[2500ms] overflow-hidden"
                                 style="transition-timing-function: steps(15); width: 0px; opacity: 0;"
                                 :style="revealed ? 'width: 100%; opacity: 1;' : 'width: 0px; opacity: 0;'">
                                <img src="{{ craft.vite.asset(props.arrowPath) }}"
                                     alt="Arrow Decor"
                                     class="w-full h-auto object-contain max-h-8 object-left block">
                            </div>
                        </div>
                    </div>

                    {# --- THE TEXT (Right 70%) --- #}
                    <div class="w-full md:w-[70%] px-8 md:px-0">
                        <h2 class="font-serif text-5xl md:text-[4.5rem] font-light leading-[0.85] tracking-tight {{ props.textColor }}">
                            {{ props.sectionTitle | nl2br | raw }}
                        </h2>
                    </div>
                </div>
            {% endif %}

            {# --- TESTIMONIAL CONTENT --- #}
            <div class="flex flex-wrap w-full items-start">
                <div class="hidden md:block md:w-[30%]"></div>

                <div class="w-full {{ props.sectionTitle is not empty ? 'md:w-[70%]' : 'md:w-full' }} px-8 md:px-0 pr-8 md:pr-24 lg:pr-32">
                    <div class="relative min-h-[350px]">
                        {% for index, testimonialEntry in testimonials %}
                            <div
                                    x-show="active === {{ index }}"
                                    x-transition:enter="transition ease-out duration-500"
                                    x-transition:enter-start="opacity-0 transform translate-x-4"
                                    x-transition:enter-end="opacity-100 transform translate-x-0"
                                    class="w-full"
                            >
                                <div class="w-12 h-12 {{ props.quoteIconColor }} flex items-center justify-center mb-10">
                                    <svg width="24" height="18" viewBox="0 0 24 18" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M0 18V10.2857L4.11429 0H9.25714L6.17143 10.2857H9.25714V18H0ZM14.7429 18V10.2857L18.8571 0H24L20.9143 10.2857H24V18H14.7429Z" fill="currentColor" class="{{ props.textColor }}"/>
                                    </svg>
                                </div>

                                <div class="font-aktiv text-lg md:text-[1.6rem] leading-relaxed mb-6 opacity-90 {{ props.textColor }} w-full">
                                    {{ testimonialEntry.blockBodyText | raw }}
                                </div>

                                <div class="font-aktiv text-sm font-bold tracking-[0.2em] uppercase {{ props.textColor }}">
                                    — {{ testimonialEntry.title }}
                                </div>
                            </div>
                        {% endfor %}
                    </div>

                    {% if testimonials | length > 1 %}
                        <div class="flex items-center gap-4 mt-8 pb-4">
                            <button @click="prev()" class="w-12 h-12 rounded-full border border-foxplan-charcoal-brown {{ props.btnBgColor }} {{ props.btnTextColor }} flex items-center justify-center transition-all duration-300 hover:opacity-80">
                                <span class="text-xl">←</span>
                            </button>
                            <button @click="next()" class="w-12 h-12 rounded-full border border-foxplan-charcoal-brown {{ props.btnBgColor }} {{ props.btnTextColor }} flex items-center justify-center transition-all duration-300 hover:opacity-80">
                                <span class="text-xl">→</span>
                            </button>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </section>
{% endif %}