{# templates/_sections/testimonials.twig #}

{# 1. Fetching the entries directly #}
{% set testimonials = craft.entries().section('testimonials').all() %}

{# 2. Merge defaults #}
{% set defaults = {
    sectionTitle: data.paragraphHeading4 ?? 'Hear what our clients are saying',
    backgroundColor: 'bg-foxplan-neutral-beige',
    textColor: 'text-foxplan-charcoal-brown',
    borderColor: 'border-foxplan-yellow',
    quoteIconColor: 'bg-foxplan-yellow',
    btnBgColor: 'bg-foxplan-charcoal-brown',
    btnTextColor: 'text-foxplan-yellow',
    arrowPath: '@webroot/dist/images/placeholder/Arrow_1.svg'
} %}

{% set props = defaults | merge(data ?? {}) %}

{% if testimonials | length %}
    <section
            class="relative {{ props.backgroundColor }} overflow-hidden border-t-[20px] border-r-[20px] border-b-[20px] {{ props.borderColor }}"
            x-data="{
            active: 0,
            revealed: false,
            total: {{ testimonials | length }},
            next() { this.active = (this.active + 1) % this.total },
            prev() { this.active = (this.active - 1 + this.total) % this.total },
            checkScroll() {
                if (this.revealed) return;
                let rect = this.$el.getBoundingClientRect();
                if (rect.top < window.innerHeight && rect.bottom >= 0) {
                    this.revealed = true;
                }
            }
        }"
            x-init="setTimeout(() => checkScroll(), 200)"
            @scroll.window.passive="checkScroll()"
    >
        <div class="w-full pt-10 lg:pt-24 pb-10 lg:pb-24">

            {# --- HEADER ROW --- #}
            {% if props.sectionTitle is not empty %}
                <div class="flex flex-wrap w-full items-center mb-16 md:mb-24 relative">

                    <div class="hidden md:flex w-[30%] items-center justify-start pr-8 lg:pr-12">
                        <div class="w-full h-8 flex items-center">
                            <div class="transition-all duration-[2500ms] overflow-hidden"
                                 style="transition-timing-function: steps(15); width: 0px; opacity: 0;"
                                 :style="revealed ? 'width: 100%; opacity: 1;' : 'width: 0px; opacity: 0;'">

                                <div class="w-full h-auto fill-current {{ props.textColor }}">
                                    {{ svg(alias(props.arrowPath))|attr({
                                        class: 'w-full h-auto block object-contain max-h-8 object-left',
                                        role: 'presentation'
                                    }) }}
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="w-full md:w-[70%] px-4 lg:px-8 md:px-0 pr-12 lg:pr-32">
                        <h2 class="font-serif tracking-tight {{ props.textColor }} break-normal"
                            style="font-size: clamp(2.5rem, 6vw + 1rem, 6.5rem); line-height: 0.85; word-break: keep-all;">
                            {{ props.sectionTitle | nl2br | raw }}
                        </h2>
                    </div>
                </div>
            {% endif %}

            {# --- TESTIMONIAL CONTENT --- #}
            <div class="flex flex-wrap w-full items-start">
                <div class="hidden md:block md:w-[30%]"></div>

                <div class="w-full {{ props.sectionTitle is not empty ? 'md:w-[70%]' : 'md:w-full' }} px-4 lg:px-8 md:px-0 pr-8 md:pr-24 lg:pr-32">
                    <div class="relative min-h-[250px] lg:min-h-[350px]">
                        {% for index, testimonialEntry in testimonials %}
                            <div
                                    x-show="active === {{ index }}"
                                    x-transition:enter="transition ease-out duration-500"
                                    x-transition:enter-start="opacity-0 transform translate-x-4"
                                    x-transition:enter-end="opacity-100 transform translate-x-0"
                                    class="w-full"
                            >
                                <div class="w-12 h-12 {{ props.quoteIconColor }} flex items-center justify-center mb-10">
                                    <svg width="24" height="18" viewBox="0 0 24 18" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M0 18V10.2857L4.11429 0H9.25714L6.17143 10.2857H9.25714V18H0ZM14.7429 18V10.2857L18.8571 0H24L20.9143 10.2857H24V18H14.7429Z" fill="currentColor" class="{{ props.textColor }}"/>
                                    </svg>
                                </div>

                                {#
                                QUOTE CLAMP
                                #}
                                <div class="font-aktiv-grotesk leading-relaxed mb-10 {{ props.textColor }} w-full font-medium break-normal"
                                     style="font-size: clamp(1.125rem, 1vw + 0.5rem, 1.5rem); word-break: keep-all;">
                                    {{ testimonialEntry.blockBodyText | raw }}
                                </div>

                                {# AUTHOR TEXT #}
                                <div class="font-aktiv-grotesk text-sm font-bold tracking-[0.2em] uppercase {{ props.textColor }} font-medium opacity-80">
                                    — {{ testimonialEntry.title }}
                                </div>
                            </div>
                        {% endfor %}
                    </div>

                    {% if testimonials | length > 1 %}
                        <div class="flex flex-row justify-center md:justify-start items-center gap-4 mt-8 pb-4">
                            <button @click="prev()" class="w-12 h-12 rounded-full border border-foxplan-charcoal-brown {{ props.btnBgColor }} {{ props.btnTextColor }} flex items-center justify-center transition-all duration-300 hover:opacity-80">
                                <span class="text-xl">←</span>
                            </button>
                            <button @click="next()" class="w-12 h-12 rounded-full border border-foxplan-charcoal-brown {{ props.btnBgColor }} {{ props.btnTextColor }} flex items-center justify-center transition-all duration-300 hover:opacity-80">
                                <span class="text-xl">→</span>
                            </button>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </section>
{% endif %}