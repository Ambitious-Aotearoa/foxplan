{# templates/_sections/timeline-section.twig #}

<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/ScrollTrigger.min.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>

{% set milestones = craft.entries.section('timeline').all() %}

<div x-data="{
    init() {
        gsap.registerPlugin(ScrollTrigger);
        const cards = gsap.utils.toArray('.milestone-card-wrapper');
        const totalSteps = cards.length;

        const tl = gsap.timeline({
            scrollTrigger: {
                trigger: this.$refs.mainSection,
                start: 'top top',
                end: () => '+=' + (totalSteps * 150) + '%', {# Increased end distance for a slower, smoother scroll #}
                pin: true,
                scrub: 1, {# Increased scrub for a 'smoother' following effect #}
                pinSpacing: true,
                anticipatePin: 1
            }
        });


        cards.forEach((card, i) => {
            if (i > 0) {
                gsap.set(card, {
                    y: 60 + (i * 10),
                    zIndex: 100 - i,
                    scale: 0.98,
                    opacity: 1
                });
            }
        });


        cards.forEach((card, i) => {
            if (i < totalSteps - 1) {
                {# The exit of the current card and entrance of the next are bundled together #}
                tl.to(cards[i], {
                    y: -150,
                    opacity: 0,
                    scale: 1.02,
                    ease: 'power2.inOut'
                }, i * 0.8)
                .to(cards[i + 1], {
                    y: 0,
                    scale: 1,
                    zIndex: 101,
                    ease: 'power2.inOut'
                }, i * 0.8);
            }
        });
    }
}"
     x-ref="mainSection"
     class="w-full h-screen flex flex-col justify-center relative m-0 p-0 border-0 bg-white overflow-hidden">

    {# --- CONTAINER (Narrower Margins) --- #}
    <div class="relative w-full max-w-[94%] mx-auto h-[500px]">
        {% for card in milestones %}
            {% set isYellow = loop.index is even %}

            <div class="milestone-card-wrapper absolute inset-0 w-full h-full">
                {% include '_components/ui/card/card.twig' with {
                    props: {
                        year: card.milestoneYear,
                        title: card.milestoneTitle,
                        text: card.milestoneText,
                        cardBg: isYellow ? 'bg-[#F1C44F]' : 'bg-white',
                        textColor: 'text-[#270E15]',
                        accentColor: 'text-[#270E15]',
                        squareColor: 'bg-[#270E15]',
                        titleColor: 'text-[#270E15]'
                    }
                } only %}
            </div>
        {% endfor %}
    </div>
</div>