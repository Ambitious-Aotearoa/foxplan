{# _sections/contact-us/contact-us.twig #}

{# 1. FETCH DYNAMIC DATA FROM CRAFT #}
{% set insightTags = craft.tags.group('insights').all() %}
{% set serviceOptions = insightTags|map(t => t.title) %}

{# Fetch Advisers #}
{% set adviserEntries = craft.entries.section('advisers').all() %}
{% set adviserNames = adviserEntries|map(a => a.title) %}

{# Fallbacks #}
{% if serviceOptions is empty %}{% set serviceOptions = ['Insurance', 'Mortgages', 'KiwiSaver'] %}{% endif %}

{# 2. MAP DATA (Finding Matrix Blocks and Assets) #}

{% set bookBlock = (entry.infoBlock is defined) ? entry.infoBlock.type('bookAnAdviser').one() : null %}
{% set locBlock = (entry.infoBlock is defined) ? entry.infoBlock.type('location').one() : null %}

{% set bookImage = (bookBlock and bookBlock.image is defined) ? bookBlock.image.one() : null %}
{% set locImage = (locBlock and locBlock.image2 is defined) ? locBlock.image2.one() : null %}

{# Define Hardcoded Fallback Paths to bypass Vite #}
{% set fallbackContact = alias('@web/dist/images/Contact_1.jpg') %}

{% set contactData = {
    call: {
        heading: entry.contactMainHeading2 ?? 'Get in touch',
        description: entry.contactBodytext2 ?? ''
    },
    callback: {
        heading: bookBlock.contactMainHeading3 ?? 'Book an adviser',
        body1: bookBlock.contactBodytext3 ?? '',
        body2: 'If you know who you would like to speak to, you can select their name from the dropdown list.',
        imageSrc: bookImage ? bookImage.url : fallbackContact,
        advisers: adviserNames,
        services: serviceOptions
        },
        location: {
        heading: locBlock.contactMainHeading ?? 'Our Location',
        body: locBlock.contactBodytext ?? '',
        imageSrc: locImage ? locImage.url : fallbackContact
        }
        } %}

        {# Styling Classes #}
        {% set descriptionClasses = 'text-base leading-relaxed mb-6 text-foxplan-charcoal-brown font-aktiv-grotesk font-light' %}
        {% set labelClasses = 'text-sm font-semibold uppercase tracking-wider mb-2 block text-foxplan-charcoal-brown font-aktiv-grotesk' %}
        {% set inputClasses = 'w-full py-2 border-b border-gray-400 focus:outline-none focus:border-gray-900 bg-transparent text-foxplan-charcoal-brown font-aktiv-grotesk' %}
        {% set tabTitleClasses = 'font-serif text-4xl sm:text-5xl lg:text-[5.5rem] font-light leading-none mb-0 text-foxplan-charcoal-brown' %}

        {# --- MACROS --- #}

        {% macro render_call_tab_content(data, descriptionClasses) %}
        <div class="grid grid-cols-1 md:grid-cols-12 gap-x-12 mt-4 px-0">
            <div class="md:col-span-5">
                <div class="{{ descriptionClasses }}">{{ data.description|raw }}</div>
        </div>
        <div class="md:col-span-7">
            {{ include('_components/form/Contact-form.twig', {
                props: { submitText: 'Submit' }
            }) }}
        </div>
    </div>
{% endmacro %}

{% macro render_callback_tab_content(data, descriptionClasses, labelClasses, inputClasses) %}
    <div class="grid grid-cols-1 lg:grid-cols-12 gap-x-0 mt-4 items-stretch">
        <div class="lg:col-span-5 px-0">
            <div class="{{ descriptionClasses }}">{{ data.body1|raw }}</div>

            <div class="grid grid-cols-2 gap-x-8 mt-10 mb-10">
                <div>
                    <label class="{{ labelClasses }}">SELECT ADVISER</label>
                    <select class="{{ inputClasses }} appearance-none rounded-none bg-transparent">
                        <option value="">Choose an Adviser</option>
                        {% for name in data.advisers %}<option value="{{ name }}">{{ name }}</option>{% endfor %}
                    </select>
                </div>
                <div>
                    <label class="{{ labelClasses }}">SELECT SERVICE</label>
                    <select class="{{ inputClasses }} appearance-none rounded-none bg-transparent">
                        <option value="">Choose a Service</option>
                        {% for service in data.services %}<option value="{{ service }}">{{ service }}</option>{% endfor %}
                    </select>
                </div>
            </div>

            <div class="{{ descriptionClasses }} mb-10">{{ data.body2|raw }}</div>

            <div class="flex">
                {{ include('_components/ui/button/button.twig', {
                    props: { text: 'Book Now', url: '#', style: 'secondary' }
                }) }}
            </div>
        </div>
        <div class="hidden lg:block lg:col-span-7 pl-12">
            <div class="w-full h-[500px] overflow-hidden">
                {# Points directly to disk path or Craft URL #}
                <img src="{{ data.imageSrc }}" alt="FoxPlan" class="w-full h-full object-cover">
            </div>
        </div>
    </div>
{% endmacro %}

{% macro render_location_tab_content(data, descriptionClasses) %}
    <div class="grid grid-cols-1 lg:grid-cols-12 gap-x-0 mt-4 items-stretch">
        <div class="lg:col-span-5 px-0">
            <div class="{{ descriptionClasses }}">{{ data.body|raw }}</div>
        </div>
        <div class="hidden lg:block lg:col-span-7 pl-12">
            <div class="w-full h-[500px] overflow-hidden">
                {# Points directly to disk path or Craft URL #}
                <img src="{{ data.imageSrc }}" alt="Location" class="w-full h-full object-cover">
            </div>
        </div>
    </div>
{% endmacro %}

{% import _self as macros %}

{% set tabsComponentData = {
    defaultTab: 'call',
    backgroundColor: 'bg-foxplan-neutral-beige',
    textColor: 'text-foxplan-charcoal-brown',
    titleClasses: tabTitleClasses,
    tabs: [
        { id: 'call', label: 'Get in touch', title: contactData.call.heading, content: macros.render_call_tab_content(contactData.call, descriptionClasses) },
        { id: 'callback', label: 'Book an adviser', title: contactData.callback.heading, content: macros.render_callback_tab_content(contactData.callback, descriptionClasses, labelClasses, inputClasses) },
        { id: 'location', label: 'Our Location', title: contactData.location.heading, content: macros.render_location_tab_content(contactData.location, descriptionClasses) }
    ]
} %}

<section class="w-full bg-foxplan-neutral-beige pt-16 pb-20 overflow-x-hidden" x-data="{ activeTab: '{{ tabsComponentData.defaultTab }}' }">
    <div class="w-full px-4 lg:px-12">
        {% include '_components/ui/tabs/tabs.twig' with { data: tabsComponentData } %}
    </div>
</section>